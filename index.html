<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>FindLoc — חיפוש מק״ט למיקום (ממשק יחיד)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--accent:#2563eb;--text:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:40px auto;padding:16px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    p.note{margin:0 0 16px;color:#475569}
    label{display:block;margin:10px 0 6px}
    input,button{font:inherit}
    input[type=text], input[type=url]{width:100%;padding:12px 14px;border:1px solid #e2e8f0;border-radius:12px;outline:none}
    input[type=text]:focus, input[type=url]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    button{padding:12px 14px;border:none;border-radius:12px;cursor:pointer}
    .primary{background:var(--accent);color:#fff}
    .ghost{background:#eef2ff;color:#1e293b}
    .danger{background:#ef4444;color:#fff}
    .muted{color:#64748b}
    .result{margin-top:14px;padding:12px 14px;background:#ecfeff;border:1px solid #bae6fd;border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right}
    th{background:#eef2ff}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#e2e8f0;padding:2px 6px;border-radius:6px}
    .flex{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 10px;background:#f1f5f9;border-radius:999px;font-size:12px}
    .clickable-row{cursor:pointer}
    .count{font-size:12px}
    .status{font-size:12px;color:#64748b;margin-top:8px}

    .hero{background:linear-gradient(180deg,#eef2ff,#ffffff);border:1px solid #dbeafe;padding:18px;border-radius:16px;box-shadow:0 8px 20px rgba(37,99,235,.10)}
    .hero .row input[type=text]{font-size:22px;padding:18px 16px}
    .hero .row button{font-size:18px;padding:18px 16px}

    .bigCard{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px;border:1px solid #bfdbfe;border-radius:14px;background:#e0f2fe}
    .bigCard .skuLine{font-size:13px;color:#334155;margin-bottom:4px}
    .bigCard .locBig{font-size:34px;font-weight:800;letter-spacing:.3px}
    .bigCard .actions button{padding:10px 12px}

    details.list{border:1px solid #e2e8f0;border-radius:12px;background:#fff;margin-top:20px}
    details.list summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;background:#eef2ff;border-radius:12px}
    details.list summary::-webkit-details-marker{display:none}
    details .chev{transition:transform .2s}
    details[open] .chev{transform:rotate(180deg)}
    .details-body{padding:12px 14px}

    .cloud{margin-top:16px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:12px}
    .cloud .hint{font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>מחסן מינימלי</h1>
      <p class="note">מחובר ל־Web App של Apps Script. אפשר לשנות את הכתובת למטה אם צריך.</p>

      <div class="hero">
        <label>חיפוש מק״ט</label>
        <div class="row">
          <input id="searchSku" type="text" inputmode="numeric" pattern="\d{4,5}" placeholder="לדוגמה: 1234" autofocus>
          <button class="primary" id="btnSearch">חפש</button>
        </div>
        <div id="searchResult" class="result" style="display:none"></div>
        <div id="cloudStatus" class="status"></div>
      </div>

      <hr style="margin:20px 0;border:none;border-top:1px solid #e2e8f0">

      <div class="flex">
        <h2 style="margin:0;font-size:18px">הוספה/עדכון</h2>
        <span class="pill muted">סנכרון דרך Web App</span>
      </div>

      <label>מק״ט (4–5 ספרות)</label>
      <input id="formSku" type="text" inputmode="numeric" pattern="\d{4,5}" placeholder="לדוגמה: 12345">
      <label>מיקום (לדוגמה: A1-03 או מדף 12)</label>
      <div class="row">
        <input id="formLoc" type="text" placeholder="לדוגמה: A1-03">
        <button class="ghost" id="btnAdd">הוסף חדש</button>
        <button class="primary" id="btnUpdate">עדכן מיקום</button>
      </div>
      <div id="formMsg" class="result" style="display:none"></div>

      <details id="listDetails" class="list" open>
        <summary>
          <h3 style="margin:0;font-size:16px">
            רשימת מק״טים <span id="count" class="count muted"></span>
          </h3>
          <span class="chev">⌃</span>
        </summary>
        <div class="details-body">
          <table id="table">
            <thead><tr><th>מק״ט</th><th>מיקום</th><th>פעולות</th></tr></thead>
            <tbody id="tbody"><tr><td colspan="3" class="muted">טוען…</td></tr></tbody>
          </table>
        </div>
      </details>

      <div class="cloud">
        <label>קישור Web App</label>
        <input id="apiUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec">
        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnSaveCloud">Сохранить ссылку</button>
          <button class="ghost" id="btnReload">Загрузить из облака</button>
          <button class="danger" id="btnWipe">נקה הכל (6165)</button>
        </div>
        <div class="hint" style="margin-top:6px">
          API (GET): <code>?action=list</code> | <code>?action=upsert&sku=1234&loc=A1-03</code> |
          <code>?action=delete&sku=1234</code> | <code>?action=wipe&code=6165</code>
        </div>
      </div>

      <p class="muted" style="margin-top:12px">טיפ: סורק ברקוד שמקליד מספרים יפעל כאן ישר, רק תן ל־<span class="kbd">חיפוש מק״ט</span> פוקוס.</p>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxWbM_GBviksh_xtXua5vj9G9q98IcGgGGyKN4lw3ARB3FTA0Aj4hRMCFJx8I4ngQgf/exec";

  const $ = s => document.querySelector(s);

  const searchSku = $("#searchSku"), btnSearch = $("#btnSearch"), searchResult = $("#searchResult");
  const formSku = $("#formSku"), formLoc = $("#formLoc"), btnAdd = $("#btnAdd"), btnUpdate = $("#btnUpdate"), formMsg = $("#formMsg");
  const tbody = $("#tbody"), countEl = $("#count"), cloudStatus = $("#cloudStatus");
  const apiUrlEl = $("#apiUrl"), btnSaveCloud = $("#btnSaveCloud"), btnReload = $("#btnReload"), btnWipe = $("#btnWipe");

  const CFG_KEY = "findloc_api_url";
  function loadApi(){ return localStorage.getItem(CFG_KEY)||DEFAULT_API; }
  function saveApi(url){ localStorage.setItem(CFG_KEY, url||DEFAULT_API); }
  let API = loadApi(); apiUrlEl.value = API;

  const validSku = v => /^\d{4,5}$/.test(v||"");
  function enforceDigits(el){
    el.addEventListener("input", ()=>{
      const d = (el.value||"").replace(/\D/g,"").slice(0,5);
      if(el.value !== d) el.value = d;
    });
  }
  enforceDigits(searchSku); enforceDigits(formSku);

  function toast(msg){
    formMsg.style.display = "block"; formMsg.textContent = msg;
    clearTimeout(toast._t); toast._t = setTimeout(()=> formMsg.style.display="none", 1600);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  let cache = new Map(); // sku -> loc

  function withApi(action, params={}){
    if(!API) throw new Error("לא הוגדר קישור Web App");
    const url = new URL(API);
    url.searchParams.set("action", action);
    for(const [k,v] of Object.entries(params)){ url.searchParams.set(k, v); }
    return fetch(url.toString(), {cache:"no-store"}).then(r=>r.json());
  }

  async function fetchList(){
    cloudStatus.textContent = "טוען מהענן…";
    try{
      const data = await withApi("list");
      if(!Array.isArray(data)) throw new Error("תגובה לא תקינה");
      cache.clear();
      for(const r of data){
        if(r && validSku(r.sku) && r.loc && String(r.loc).toLowerCase()!=='nan'){
          cache.set(String(r.sku).trim(), String(r.loc).trim());
        }
      }
      render();
      cloudStatus.textContent = `נטען: ${cache.size} פריטים.`;
    }catch(e){
      cloudStatus.textContent = "שגיאה בטעינה: " + e.message;
    }
  }

  function render(){
    tbody.innerHTML = "";
    const rows = [...cache.entries()].map(([sku,loc])=>({sku,loc})).sort((a,b)=> a.sku.localeCompare(b.sku,'he'));
    countEl.textContent = rows.length ? `(${rows.length})` : "";
    if(!rows.length){
      const tr = document.createElement("tr"); const td = document.createElement("td");
      td.colSpan = 3; td.textContent = "אין נתונים"; td.className = "muted";
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const row of rows){
      const tr = document.createElement("tr"); tr.className = "clickable-row";
      const tdSku = document.createElement("td"); tdSku.textContent = row.sku;
      const tdLoc = document.createElement("td"); tdLoc.textContent = row.loc;
      const tdAct = document.createElement("td");

      const copyBtn = document.createElement("button"); copyBtn.textContent = "העתק"; copyBtn.className = "ghost";
      copyBtn.onclick = async (e)=>{ e.stopPropagation(); await navigator.clipboard.writeText(row.loc); toast(`הועתק: ${row.loc}`); };

      const delBtn = document.createElement("button"); delBtn.textContent = "מחק"; delBtn.className = "danger";
      delBtn.onclick = async (e)=>{
        e.stopPropagation();
        await withApi("delete", {sku: row.sku});
        cache.delete(row.sku); render(); toast("נמחק");
      };

      tr.onclick = ()=>{ formSku.value = row.sku; formLoc.value = row.loc; formLoc.focus(); };
      tdAct.append(copyBtn, " ", delBtn);
      tr.append(tdSku, tdLoc, tdAct); tbody.appendChild(tr);
    }
  }

  function showSearchResult(sku, loc){
    searchResult.style.display = "block";
    if(!loc){ searchResult.innerHTML = `לא נמצא מק״ט ${sku}.`; return; }
    searchResult.innerHTML = `
      <div class="bigCard">
        <div>
          <div class="skuLine">המיקום של <strong>${sku}</strong>:</div>
          <div class="locBig" dir="ltr">${escapeHtml(loc)}</div>
        </div>
        <div class="actions"><button class="ghost" id="btnCopyLoc">העתק</button></div>
      </div>`;
    const copyBtn = document.getElementById("btnCopyLoc");
    if(copyBtn){ copyBtn.onclick = async ()=>{ await navigator.clipboard.writeText(loc); toast(\`הועתק: ${loc}\`); }; }
  }

  function doSearch(){
    const sku = (searchSku.value||"").trim();
    if(!validSku(sku)){
      searchResult.style.display = "block";
      searchResult.innerHTML = "מק״ט לא תקין — צריך 4–5 ספרות.";
      return;
    }
    showSearchResult(sku, cache.get(sku));
  }

  async function addNew(){
    const sku = (formSku.value||"").trim();
    const loc = (formLoc.value||"").trim();
    if(!validSku(sku)) return toast("מק״ט לא תקין (4–5 ספרות).");
    if(!loc) return toast("צריך למלא מיקום.");
    await withApi("upsert", {sku, loc});
    cache.set(sku, loc); render(); toast("נוסף בהצלחה.");
  }

  async function updateLoc(){
    const sku = (formSku.value||"").trim();
    const loc = (formLoc.value||"").trim();
    if(!validSku(sku)) return toast("מק״ט לא תקין (4–5 ספרות).");
    if(!loc) return toast("צריך למלא מיקום.");
    await withApi("upsert", {sku, loc});
    cache.set(sku, loc); render(); toast("עודכן בהצלחה.");
  }

  async function wipeAll(){
    const code = prompt("להמשך מחיקה הזן/ני קוד:");
    if(code !== "6165"){ toast("קוד מחיקה שגוי."); return; }
    if(!confirm("אישור סופי: למחוק את כל הנתונים בגיליון?")){ toast("בוטל."); return; }
    await withApi("wipe", {code});
    cache.clear(); render(); toast("נוקה.");
  }

  btnSearch.addEventListener("click", doSearch);
  searchSku.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); doSearch(); } });
  btnAdd.addEventListener("click", e=>{ e.preventDefault(); addNew(); } );
  btnUpdate.addEventListener("click", e=>{ e.preventDefault(); updateLoc(); } );
  formLoc.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); updateLoc(); } });

  btnSaveCloud.addEventListener("click", ()=>{ API = (apiUrlEl.value||"").trim(); saveApi(API); toast("הקישור נשמר."); });
  btnReload.addEventListener("click", fetchList);
  btnWipe.addEventListener("click", wipeAll);

  window.addEventListener("load", ()=>{
    setTimeout(()=> searchSku.focus(), 120);
    fetchList(); // נטען מיידית מה־DEFAULT_API
  });
})();
</script>
</body>
</html>
